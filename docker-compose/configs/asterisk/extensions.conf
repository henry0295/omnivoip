;================================ GLOBALS ================================
[globals]
CONSOLE=Console/dsp
TRUNK=PJSIP/trunk-provider

;================================ GENERAL ================================
[general]
static=yes
writeprotect=no
clearglobalvars=no

;================================ FROM AGENTS (WebRTC) ================================
[from-agents]
; Agent login/logout
exten => *10,1,NoOp(Agent Login)
    same => n,Answer()
    same => n,AddQueueMember(sales,PJSIP/${CALLERID(num)})
    same => n,AddQueueMember(support,PJSIP/${CALLERID(num)})
    same => n,Playback(agent-loginok)
    same => n,Hangup()

exten => *11,1,NoOp(Agent Logout)
    same => n,Answer()
    same => n,RemoveQueueMember(sales,PJSIP/${CALLERID(num)})
    same => n,RemoveQueueMember(support,PJSIP/${CALLERID(num)})
    same => n,Playback(agent-loggedoff)
    same => n,Hangup()

; Agent pause/unpause
exten => *20,1,NoOp(Agent Pause)
    same => n,Answer()
    same => n,PauseQueueMember(sales,PJSIP/${CALLERID(num)})
    same => n,PauseQueueMember(support,PJSIP/${CALLERID(num)})
    same => n,Playback(agent-pause)
    same => n,Hangup()

exten => *21,1,NoOp(Agent Unpause)
    same => n,Answer()
    same => n,UnpauseQueueMember(sales,PJSIP/${CALLERID(num)})
    same => n,UnpauseQueueMember(support,PJSIP/${CALLERID(num)})
    same => n,Playback(agent-unpause)
    same => n,Hangup()

; Outbound calls
exten => _X.,1,NoOp(Outbound call from ${CALLERID(num)} to ${EXTEN})
    same => n,Set(CHANNEL(language)=es)
    same => n,Set(CDR(accountcode)=${CALLERID(num)})
    same => n,Set(CDR(userfield)=OUTBOUND)
    same => n,MixMonitor(/var/spool/asterisk/monitor/${UNIQUEID}.wav,b)
    same => n,Dial(${TRUNK}/${EXTEN},60,tTkK)
    same => n,Hangup()

; Extension to extension
exten => _1XXX,1,NoOp(Internal call from ${CALLERID(num)} to ${EXTEN})
    same => n,Set(CHANNEL(language)=es)
    same => n,Dial(PJSIP/${EXTEN},30,tTkK)
    same => n,Voicemail(${EXTEN}@default,u)
    same => n,Hangup()

; Queue direct access
exten => 2000,1,NoOp(Sales Queue)
    same => n,Answer()
    same => n,Queue(sales,tTkK)
    same => n,Hangup()

exten => 2001,1,NoOp(Support Queue)
    same => n,Answer()
    same => n,Queue(support,tTkK)
    same => n,Hangup()

; Voicemail
exten => *98,1,NoOp(Voicemail Access)
    same => n,Answer()
    same => n,VoiceMailMain(${CALLERID(num)}@default)
    same => n,Hangup()

; Echo test
exten => *43,1,NoOp(Echo Test)
    same => n,Answer()
    same => n,Echo()
    same => n,Hangup()

; Music on hold test
exten => *60,1,NoOp(Music On Hold)
    same => n,Answer()
    same => n,MusicOnHold()

;================================ FROM WEBRTC ================================
[from-webrtc]
include => from-agents

;================================ FROM INTERNAL ================================
[from-internal]
include => from-agents

;================================ FROM KAMAILIO ================================
[from-kamailio]
; Calls from Kamailio (WebRTC gateway)
exten => _X.,1,NoOp(Call from Kamailio to ${EXTEN})
    same => n,Set(CHANNEL(language)=es)
    same => n,Goto(from-agents,${EXTEN},1)

;================================ FROM QUEUES ================================
[from-queues]
; Context for queue member callbacks
exten => _X.,1,NoOp(Queue member call)
    same => n,Dial(PJSIP/${EXTEN},30)
    same => n,Hangup()

;================================ INBOUND (FROM TRUNK) ================================
[from-trunk]
; IVR Main Menu
exten => s,1,NoOp(Incoming call from ${CALLERID(num)})
    same => n,Answer()
    same => n,Set(CHANNEL(language)=es)
    same => n,Set(CDR(accountcode)=INBOUND)
    same => n,Set(CDR(userfield)=CAMPAIGN_${ARG1})
    same => n,MixMonitor(/var/spool/asterisk/monitor/${UNIQUEID}.wav,b)
    same => n,Goto(ivr-main,s,1)

; DID routing - example
exten => _+1234567890,1,NoOp(Incoming to Sales)
    same => n,Set(CAMPAIGN=sales)
    same => n,Goto(s,1)

exten => _+0987654321,1,NoOp(Incoming to Support)
    same => n,Set(CAMPAIGN=support)
    same => n,Goto(s,1)

;================================ IVR MENUS ================================
[ivr-main]
exten => s,1,NoOp(Main IVR)
    same => n,Answer()
    same => n(welcome),Background(welcome)
    same => n,Background(main-menu)
    same => n,WaitExten(10)
    same => n,Goto(welcome)

; Option 1 - Sales
exten => 1,1,NoOp(Sales selected)
    same => n,Queue(sales,tT)
    same => n,Voicemail(2000@default,u)
    same => n,Hangup()

; Option 2 - Support
exten => 2,1,NoOp(Support selected)
    same => n,Queue(support,tT)
    same => n,Voicemail(2001@default,u)
    same => n,Hangup()

; Option 3 - Directory
exten => 3,1,NoOp(Directory)
    same => n,Directory(default,from-trunk)
    same => n,Goto(s,welcome)

; Option 0 - Operator
exten => 0,1,NoOp(Operator)
    same => n,Queue(support,tT)
    same => n,Hangup()

; Invalid option
exten => i,1,NoOp(Invalid option)
    same => n,Playback(invalid)
    same => n,Goto(s,welcome)

; Timeout
exten => t,1,NoOp(Timeout)
    same => n,Playback(vm-goodbye)
    same => n,Hangup()

;================================ FROM EXTERNAL ================================
[from-external]
; Default external context
exten => _X.,1,NoOp(External call)
    same => n,Goto(from-trunk,s,1)

;================================ OUTBOUND CAMPAIGNS ================================
[outbound-campaign]
; Context for predictive dialer
exten => _X.,1,NoOp(Outbound campaign call to ${EXTEN})
    same => n,Set(CHANNEL(language)=es)
    same => n,Set(CDR(accountcode)=CAMPAIGN)
    same => n,Set(CDR(userfield)=${ARG1})
    same => n,MixMonitor(/var/spool/asterisk/monitor/${UNIQUEID}.wav,b)
    same => n,Dial(${TRUNK}/${EXTEN},60,gM(campaign-connected))
    same => n,Goto(campaign-result,${DIALSTATUS},1)

; Macro for when call is connected
[macro-campaign-connected]
exten => s,1,NoOp(Call connected)
    same => n,Wait(1)
    same => n,AGI(agi://localhost:4573/connect_agent)
    same => n,Return()

; Handle dial results
[campaign-result]
exten => ANSWER,1,NoOp(Call answered)
    same => n,Hangup()

exten => BUSY,1,NoOp(Busy)
    same => n,Hangup()

exten => NOANSWER,1,NoOp(No answer)
    same => n,Hangup()

exten => CANCEL,1,NoOp(Cancelled)
    same => n,Hangup()

exten => CONGESTION,1,NoOp(Congestion)
    same => n,Hangup()

exten => CHANUNAVAIL,1,NoOp(Channel unavailable)
    same => n,Hangup()

;================================ CALL TRANSFER ================================
[call-transfer]
; Context for attended transfers
exten => _X.,1,NoOp(Transfer to ${EXTEN})
    same => n,Dial(PJSIP/${EXTEN},30)
    same => n,Hangup()

;================================ CONFERENCE ================================
[conference]
exten => _8XXX,1,NoOp(Conference ${EXTEN})
    same => n,Answer()
    same => n,ConfBridge(${EXTEN})
    same => n,Hangup()

;================================ PARKING ================================
[parkedcalls]
; Call parking
exten => _7XX,1,NoOp(Parked call ${EXTEN})
    same => n,ParkedCall(${EXTEN})
    same => n,Hangup()

;================================ HANGUP HANDLER ================================
[hangup-handler]
exten => s,1,NoOp(Call ended - cleaning up)
    same => n,AGI(agi://localhost:4573/call_ended)
    same => n,Return()
